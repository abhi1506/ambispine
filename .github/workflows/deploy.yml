# name: Deploy React Build to Multiple Nginx Folders

# on:
#   push:
#     branches:
#       - main

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code with full history
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0
#           persist-credentials: true

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 22

#       - name: Install dependencies
#         working-directory: web
#         run: npm install

#       - name: Build React/Vite app
#         working-directory: web
#         run: npm run build

#       # Copy to site1
#       - name: Copy to site1
#         uses: appleboy/scp-action@v0.1.7
#         with:
#           host: ${{ secrets.SERVER_IP }}
#           username: ${{ secrets.SERVER_USER }}
#           key: ${{ secrets.SERVER_KEY }}
#           source: "web/dist/*"
#           target: "/var/www/site1/"

#       # Copy to site2
#       - name: Copy to site2
#         uses: appleboy/scp-action@v0.1.7
#         with:
#           host: ${{ secrets.SERVER_IP }}
#           username: ${{ secrets.SERVER_USER }}
#           key: ${{ secrets.SERVER_KEY }}
#           source: "web/dist/*"
#           target: "/var/www/site2/"

#       # Copy to site3
#       - name: Copy to site3
#         uses: appleboy/scp-action@v0.1.7
#         with:
#           host: ${{ secrets.SERVER_IP }}
#           username: ${{ secrets.SERVER_USER }}
#           key: ${{ secrets.SERVER_KEY }}
#           source: "web/dist/*"
#           target: "/var/www/site3/"

#       # Reload nginx (no restart)
#       - name: Reload Nginx
#         uses: appleboy/ssh-action@v0.1.7
#         with:
#           host: ${{ secrets.SERVER_IP }}
#           username: ${{ secrets.SERVER_USER }}
#           key: ${{ secrets.SERVER_KEY }}
#           script: |
#             sudo nginx -t
#             sudo systemctl reload nginx
# |
            # sudo systemctl restart nginx
            
# name: Deploy Frontend to NGINX

# on:
#   push:
#     branches:
#       - main

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 22

#       - name: Install dependencies
#         working-directory: web
#         run: npm install

#       - name: Build frontend
#         working-directory: web
#         run: npm run build

#       - name: Copy build to server
#         uses: appleboy/scp-action@v0.1.7
#         with:
#           host: ${{ secrets.SERVER_IP }}
#           username: ${{ secrets.SERVER_USER }}
#           key: ${{ secrets.SERVER_SSH_KEY }}
#           rm: true
#           source: "web/dist/*"   # Vite → dist; React → build
#           target: "/var/www/myapp"
          
#       - name: Restart NGINX
#         uses: appleboy/ssh-action@v0.1.7
#         with:
#           host: ${{ secrets.SERVER_IP }}
#           username: ${{ secrets.SERVER_USER }}
#           key: ${{ secrets.SERVER_SSH_KEY }}
#           script: |
#             sudo systemctl restart nginx

# name: Deploy to EC2 + Nginx

# on:
#   push:
#     branches:
#       - main

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       # 1️⃣ Checkout code
#       - name: Checkout code
#         uses: actions/checkout@v3

#       # 2️⃣ Build project (if needed)
#       - name: Build Project
#         run: |
#           npm install
#           npm run build

#       # 3️⃣ Test SSH connectivity
#       - name: Test SSH Connection
#         run: |
#           ssh -i ${{ secrets.SERVER_SSH_KEY }} -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} "echo 'Connected to EC2!'"

#       # 4️⃣ Copy files to server
#       - name: Copy files to EC2
#         uses: appleboy/scp-action@v0.1.7
#         with:
#           host: ${{ secrets.SERVER_IP }}
#           username: ubuntu
#           key: ${{ secrets.SERVER_SSH_KEY }}
#           port: 22
#           source: "build/"                      # your local folder
#           target: "/var/www/html/myapp"         # Nginx root folder
#           overwrite: true
#           strip_components: 0
#           debug: true

#       # 5️⃣ Set permissions & reload Nginx
#       - name: Set Permissions & Reload Nginx
#         run: |
#           ssh -i ${{ secrets.SERVER_SSH_KEY }} -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} "
#             sudo chown -R www-data:www-data /var/www/html/myapp;
#             sudo chmod -R 755 /var/www/html/myapp;
#             sudo nginx -t;
#             sudo systemctl reload nginx
#           "
name: Deploy React to EC2 + Nginx

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Setup Node
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      # 3️⃣ Build React app in /web
      - name: Install and Build
        working-directory: ./web
        run: |
          npm install
          npm run build

      # 4️⃣ Add SSH key
      - name: Add SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      # 5️⃣ Test SSH connection
      - name: Test SSH Connection
        run: ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} "echo 'Connected to EC2!'"

      # 6️⃣ Copy build files to server
      - name: Copy Build to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ubuntu
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          source: "web/build/*"              # adjust if using Vite (dist)
          target: "/var/www/html/myapp"      # change to your server path
          overwrite: true
          strip_components: 0
          debug: true

      # 7️⃣ Set permissions & reload Nginx
      - name: Set Permissions & Reload Nginx
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.SERVER_IP }} "
            sudo chown -R www-data:www-data /var/www/html/myapp;
            sudo chmod -R 755 /var/www/html/myapp;
            sudo nginx -t;
            sudo systemctl reload nginx
          "
